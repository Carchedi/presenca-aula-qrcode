<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerador de QR Code para Turmas</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      /* Seus estilos existentes... */
      #qrCodeContainer img {
        max-width: 300px;
        height: auto;
        margin-top: 20px;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
      #loadingSpinner {
        display: none;
      }
      #qrCodeResult {
        min-height: 350px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4 text-center">Gerador de QR Code - Presença</h1>

      <div class="row justify-content-center">
        <div class="col-md-6">
          <!-- NOVO: Seletor de Data -->
          <div class="mb-3">
            <label for="dataSelect" class="form-label">Selecione a Data:</label>
            <input type="date" class="form-control" id="dataSelect" />
          </div>
          <!-- FIM DO NOVO SELETOR DE DATA -->

          <!-- Seletor de Turma -->
          <div class="mb-3">
            <label for="turmaSelect" class="form-label"
              >Selecione a Turma:</label
            >
            <select class="form-select" id="turmaSelect">
              <option selected disabled value="">
                -- Escolha uma turma --
              </option>
              {% for turma in turmas %}
              <option value="{{ turma }}">{{ turma }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Área para exibir o QR Code e informações -->
          <div id="qrCodeResult" class="text-center mt-4">
            <div
              class="spinner-border text-primary"
              role="status"
              id="loadingSpinner"
            >
              <span class="visually-hidden">Gerando QR Code...</span>
            </div>
            <div id="qrCodeContainer"></div>
            <!-- Atualizaremos esta info via JS -->
            <p id="selecaoInfo" class="mt-2 fw-bold"></p>
            <p id="instrucaoScan" class="text-muted" style="display: none">
              Peça aos alunos para escanearem o código acima.
            </p>
          </div>

          <!-- Área para mensagens de erro -->
          <div
            id="errorMessage"
            class="alert alert-danger mt-3"
            style="display: none"
            role="alert"
          ></div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <!-- Nosso JavaScript (ainda não modificado para usar a data) -->
    <script>
      // Pega referências aos elementos HTML
      const turmaSelect = document.getElementById("turmaSelect");
      const dataSelect = document.getElementById("dataSelect"); // Já existia
      const qrCodeContainer = document.getElementById("qrCodeContainer");
      const selecaoInfo = document.getElementById("selecaoInfo"); // Já existia
      const instrucaoScan = document.getElementById("instrucaoScan");
      const loadingSpinner = document.getElementById("loadingSpinner");
      const errorMessageDiv = document.getElementById("errorMessage");

      // Função para buscar e exibir o QR Code
      async function fetchAndDisplayQrCode() {
        const selectedTurma = turmaSelect.value;
        const selectedDate = dataSelect.value; // Pega o valor da data (formato AAAA-MM-DD)

        // Limpa o estado anterior sempre que a função é chamada
        qrCodeContainer.innerHTML = "";
        selecaoInfo.textContent = "";
        instrucaoScan.style.display = "none";
        errorMessageDiv.style.display = "none";
        errorMessageDiv.textContent = "";

        // Só prossegue se AMBOS, turma E data, estiverem selecionados
        if (!selectedTurma || !selectedDate) {
          // Poderia adicionar uma mensagem tipo "Selecione turma e data"
          // console.log("Turma ou data não selecionada.");
          return;
        }

        // Formata a data para exibição (DD/MM/AAAA) - Opcional, mas melhora a UI
        let displayDate = selectedDate; // Usa AAAA-MM-DD por padrão
        try {
          const dateParts = selectedDate.split("-"); // [AAAA, MM, DD]
          if (dateParts.length === 3) {
            displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
          }
        } catch (e) {
          console.warn("Não foi possível formatar a data para exibição.");
        }

        loadingSpinner.style.display = "block"; // Mostra o spinner

        try {
          // ENVIA AMBOS: turma e data (no formato AAAA-MM-DD)
          const response = await fetch("/generate_qr", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            // Envia turma e data no corpo da requisição
            body: JSON.stringify({ turma: selectedTurma, data: selectedDate }),
          });

          loadingSpinner.style.display = "none"; // Esconde o spinner

          if (!response.ok) {
            const errorData = await response.json().catch(() => null);
            // Tenta pegar a mensagem de erro específica do backend
            const errorMsg =
              errorData?.error ||
              `Erro ${response.status}: ${response.statusText}`;
            throw new Error(errorMsg);
          }

          const data = await response.json();

          // Verifica se o backend retornou o QR code
          if (data.qr_code) {
            const img = document.createElement("img");
            img.src = data.qr_code;
            // Atualiza o alt text com turma e data formatada
            img.alt = `QR Code para ${selectedTurma} - ${displayDate}`;
            img.classList.add("img-fluid");

            qrCodeContainer.appendChild(img);
            // Atualiza a informação exibida com turma e data formatada
            selecaoInfo.textContent = `QR Code para: ${selectedTurma} - ${displayDate}`;
            instrucaoScan.style.display = "block"; // Mostra a instrução
          } else {
            // Caso o backend não retorne QR code (ex: link não encontrado)
            // O erro já deve ter sido tratado no !response.ok, mas é uma segurança extra
            throw new Error(data.error || "Resposta inválida do servidor.");
          }
        } catch (error) {
          console.error("Erro ao gerar QR Code:", error);
          loadingSpinner.style.display = "none"; // Garante que o spinner suma em caso de erro
          errorMessageDiv.textContent = `Erro: ${error.message}`; // Exibe a mensagem de erro
          errorMessageDiv.style.display = "block";
        }
      }

      // Adiciona listeners para AMBOS os seletores
      // Qualquer mudança em um deles tentará gerar o QR Code (se ambos tiverem valor)
      turmaSelect.addEventListener("change", fetchAndDisplayQrCode);
      dataSelect.addEventListener("change", fetchAndDisplayQrCode);
    </script>
  </body>
</html>
